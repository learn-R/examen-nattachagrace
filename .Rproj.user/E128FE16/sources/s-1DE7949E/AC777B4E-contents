---
title: "Tarea N°5"
author: "Nattacha Benitez y Bárbara Sepúlveda"
subtitle: "Análisis de Regresión Múltiple"
date: "02-11-2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, warning = F, message = F)
Sys.setlocale("LC_CTYPE", "spanish")
options(OutDec= ",", digits = 3)

```


##1. Cargamos los paquetes
```{r paquetes, echo=FALSE, results='hide'}
pacman::p_load(tidyverse, haven, sjPlot, sjmisc, survey, srvyr)

```

##2. Cargamos los datos
```{r datos, include=FALSE}
datos_proc <- readRDS("output/data/datos_proc.rds")

```

##3. Creamos Objeto Encuesta

```{r obj_enc, echo=FALSE}
obj_enc <- datos_proc %>% 
  as_survey_design(ids = 1 ,
                   weights = factor_expansion) 
```

##**4. Análisis de Correlación**
```{r correlacion, echo=FALSE}
datos_proc %>%
select(cuidarse, riesgo_cont) %>% 
tab_corr(.,
         triangle = "lower",   
         title = "Tabla 1 Matriz de correlación",
         encoding = "UTF-8", 
         file = "output/figures/tabla_correlacion.doc")
```

#4.1 Existe una muy baja correlación entre la variable cumplimiento de las medidas sanitarias y la percepción de riesgo. Tienen una dirección positiva y no existe una correlación estadísticamente significativa ya que el valor asociado es mayor al valor p. 

##**5. Regresión lineal múltiple**
#5.a Creamos los modelos de regresión 
```{r rlm, echo=FALSE}
modelo1 <- lm(cuidarse ~ riesgo_cont + trabaja + edad, weights= factor_expansion, data = datos_proc)

modelo2 <- lm(cuidarse ~ riesgo + trabaja + edad, weights = factor_expansion, data = datos_proc)

```

#5.b Creamos una tabla para presentar ambos modelos
```{r tabla, echo=FALSE, warning=FALSE}
sjPlot::tab_model(list(modelo1,modelo2),
  string.intercept = "(Intercepto)",
  string.pred = "Predictores",
  p.style = "stars",
  show.ci = FALSE,
  collapse.ci = T,
  digits = 3,
  dv.labels = c("Modelo 1", "Modelo 2"),
  show.reflvl = TRUE,
  encoding = "UTF-8",
  lang = "es")

```

#**5.d Interpretación de coeficientes de regresión para el Modelo 2**

#Según el r de pearson informado el nivel de asociación entre las variables del modelo es muy bajo, dado que se encuentra en el intervalo 0.027/0.020. La dirección en general del modelo tiende a ser positiva a pesar del valor negativo en la variable "trabaja" y la categoría "No".

#**5.e. Interpretación de hipótesis**
```{r forest_plot, echo=FALSE, warning=FALSE}
plot_model(modelo2, type = c("est"),
  show.intercept = T,
  show.values = T,
  show.p = T,
  digits = 3,
  vline.color = "green",
  title = "Modelo de regresión lineal para modelo 2")
```

#H1 : Se puede aceptar la hipótesis e indicar que el resultado es favorable. Ahora bien, la significancia de la relación entre la variable riesgo y cuidarse se cumple en un 0.001 para "Extremadamente pelirgroso" (la categoría más alta), en general el modelo presenta un R cuadrado muy bajo, lo que indica que el modelo no explica una asociación importante o de peso. 

#H2: Las personas que no trabajan tienen una asociacion débil y sin significancia estadística, por lo tanto se podría deducir que las personas que sí trabajan, podrían presentar una asociacion más fuerte con la variable dependiente. 

#H3:Esto no puede concluirse ya que la variable no se encuentra en la base de datos especificada.

#H4: Ser adulto mayor resulta en una asociación débil respecto a la variable dependiente, sin embargo, en este caso la categoría jovenes es una categoría de referencia. No se puede estimar si los adultos mayores presentan mayor frecuencia en este modelo, pero a partir de los demás datos, si se puede interpretar, que presentan mayor frecuencia que los adultos. 

#En general, el modelo no es estadísticamente significativo porque el estadístico F, es mayor a 0,05. Por lo tanto, las variables independientes solo explican un 0,02 de la variable dependiente. Con un R cuadrado muy bajo, el modelo no tiene mayor relevancia estadística. 

#**5.g Medida de cuidado esperada**
```{r tabla valores esperados, echo=FALSE}
get_model_data (modelo2, 
                type = c("pred"),
                terms = "trabaja")

sjPlot::plot_model(modelo2, 
                   show.p = T,
                   type = c("pred"),
                   terms = c("trabaja"),  
                   digits = 3,
                   show.values =  T,
                   title = "Gráfico medida de cuidado esperada",
                   vline.color = "purple")

```

##**6. Regresión logística**

*Modelo nulo
```{r m_nulo, echo=FALSE, warning=FALSE}
modelo_nulo <- glm(dummy_cuidarse ~ 1,
              data = datos_proc, 
              weights = factor_expansion,
              family = binomial(link = "logit"))

```

*Modelo 3 con edad
```{r modelo3, echo=FALSE}
modelo3 <- glm(dummy_cuidarse ~ edad,
              data = datos_proc,
              family = binomial(link = "logit"))

```

*Modelo 4 con trabajo
```{r modelo4, echo=FALSE}
modelo4 <- glm(dummy_cuidarse ~ trabaja,
              data = datos_proc, 
              family = binomial(link = "logit"))

```

*Modelo 5 con edad y trabajo
```{r modelo5, echo=FALSE}
modelo5 <- glm(dummy_cuidarse ~ trabaja + edad,
              data = datos_proc, 
              family = binomial(link = "logit"))

```

*Modelo 6 con todos los predictores
```{r modelo6, echo=FALSE, warning=FALSE}
modelo6 <- glm(dummy_cuidarse ~ trabaja + edad + riesgo,
              data = datos_proc, 
              family = binomial(link = "logit"))
```

*Modelo 6 con todos los predictores para nivel poblacional
```{r modelo_6, echo=FALSE, warning=FALSE}
modelo6_1 <- svyglm(dummy_cuidarse ~ trabaja + edad + riesgo,
                         family = binomial(link = "logit"),
                         design = obj_enc,
                    data = datos_proc)
```

#**6.b Tabla completa coeficientes exponenciados**
```{r tabla_comp, echo=FALSE, warning=FALSE}
sjPlot::tab_model(list(modelo_nulo,modelo3,modelo4,modelo5,modelo6),
  string.intercept = "(Intercepto)",
  string.pred = "Predictores",
  string.est = "Estimación Odds Ratio",
  p.style = "stars",
  digits = 3,
  collapse.ci = T,
  title = "Tabla completa con coeficientes exponenciados",
  dv.labels = c("Modelo nulo", "Modelo 3", "Modelo 4", "Modelo 5", "Modelo 6"),
  transform = 'exp',
  show.reflvl = TRUE,
  encoding = "UTF-8",
  lang = "es")
```

*6.c Interpretación de coeficientes para el Modelo 6
*La dirección es positiva para todos los predictores del modelo. El predictor de percepcion de riesgo "extremadamente peligroso", es el que tiene mayor peso dentro del modelo, por lo tanto implica que las personas que perciben así el riesgo tienen una probabilidad de aumentar en 1.99 unidades de cumplir con las medidas de distanciamiento físico (variable categórica dummy_cuidarse) con una significancia de 0.001, es decir 99% de confianza. Pero además respecto a la edad, las personas que pertenen al grupo de "Adulto mayor" tienen probabilidad de aumento de 0.17 unidades de cumplir con las medidas de distancia física sin significancia estadística. 
*Respecto al trabajo, las personas que no han trabajado aumentan en 0.03 unidades la probabilidad de cumplir con las medidas de distancia física. 


*6.d Gráfico de valores predichos Modelo 6 según edad
```{r graf_pred, echo=FALSE}
sjPlot::plot_model(modelo6, 
                   show.p = T,
                   type = c("pred"),
                   terms = c("edad"),  
                   digits = 3,
                   show.values =  T,
                   title = "Gráfico de valores predichos",
                   vline.color = "purple")
```

*6.e Comparación de estimación 

```{r model6, echo=FALSE, message=FALSE}
summary(modelo6)$deviance
summary(modelo6)$aic
```

```{r model6_1, echo=FALSE, message=FALSE}
summary(modelo6_1)$deviance
summary(modelo6_1)$aic
```

*Tabla con ambos modelos 
```{r tabl_e, echo=FALSE}
sjPlot::tab_model(list(modelo6, modelo6_1),
  string.intercept = "(Intercepto)",
  string.pred = "Predictores",
  string.est = "Estimación Odds Ratio",
  p.style = "stars",
  digits = 3,
  df.method = 'wald',
  collapse.ci = T,
  title = "Tabla Modelos 6 y muestral",
  dv.labels = c("Modelo 6", "Modelo 6 muestral"),
  transform = 'exp',
  show.reflvl = TRUE,
  encoding = "UTF-8",
  lang = "es")
```

*Ambos modelos presentan un AIC alto, lo que explica que ninguno de los dos se ajusta a los datos. Sin embargo, el modelo 6_1 de diseño complejo presenta un valor AIC y de devianza menor al modelo 6, por lo tanto, se ajusta mejor a los datos. El modelo 6 con diseño muestral, podría ser mas certero porque incorpora el diseño muestral que permite integrar características estadísticamente deseables. Por esto, resulta importante conocer paquetes y códigos que permitan ejecutar un análisis distinto para ciertos modelos y objetivos, ya que se pueden comparar y decidir finalmente de que forma se puede estimar mas estadísticamente correcto un modelo de regresión logística. 